<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Таблет за подпис</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <style>
        html, body { height: 100%; margin: 0; overflow: hidden; }
        body { display: flex; align-items: center; justify-content: center; background-color: #343a40; color: white; }
        .container { width: 100%; height: 100%; display: flex; flex-direction: column; }
        #waiting-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; }
        #signature-screen { display: none; width: 100%; height: 100%; flex-direction: column; }
        .signature-pad { border: 2px dashed #6c757d; border-radius: 0.5rem; width: 100%; flex-grow: 1; touch-action: none; }
        .info-header { background-color: #495057; padding: 1rem; border-radius: 0.5rem; }
    </style>
</head>
<body>

<div class="container p-3">
    <div id="waiting-screen">
        <i class="bi bi-tablet-landscape-fill" style="font-size: 8rem;"></i>
        <h1 class="mt-4">Таблетът е готов за работа</h1>
        <p class="lead">Изчаква се заявка за подпис от компютъра...</p>
        <div class="spinner-border text-light mt-3" role="status"><span class="visually-hidden">Loading...</span></div>
    </div>

    <div id="signature-screen">
        <div class="info-header mb-3">
            <p class="mb-1"><strong>Читател:</strong> <span id="reader-info"></span></p>
            <p class="mb-0"><strong>Книга:</strong> <span id="book-info"></span></p>
        </div>
        <canvas id="signature-pad" class="signature-pad"></canvas>
        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
            <button class="btn btn-secondary me-md-2" id="clear-btn" type="button"><i class="bi bi-eraser-fill"></i> Изчисти</button>
            <button class="btn btn-primary" id="submit-btn" type="button"><i class="bi bi-check-circle-fill"></i> Потвърди подпис</button>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const socket = io();
    const waitingScreen = document.getElementById('waiting-screen');
    const signatureScreen = document.getElementById('signature-screen');
    const readerInfoSpan = document.getElementById('reader-info');
    const bookInfoSpan = document.getElementById('book-info');
    const canvas = document.getElementById('signature-pad');
    const signaturePad = new SignaturePad(canvas, { backgroundColor: 'rgb(255, 255, 255)' });
    
    let currentBrowserSid = null;

    function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
        signaturePad.clear();
    }
    window.addEventListener("resize", resizeCanvas);

    socket.on('connect', () => {
        console.log('Connected to server, registering as tablet...');
        socket.emit('register_client', { type: 'tablet' });
    });

    socket.on('show_signature_pad', (data) => {
        console.log('Received signature request:', data);
        currentBrowserSid = data.browser_sid; 
        readerInfoSpan.textContent = data.reader_info;
        bookInfoSpan.textContent = data.book_info;
        waitingScreen.style.display = 'none';
        signatureScreen.style.display = 'flex';
        resizeCanvas();
    });

    document.getElementById('clear-btn').addEventListener('click', () => {
        signaturePad.clear();
    });

    document.getElementById('submit-btn').addEventListener('click', () => {
        if (signaturePad.isEmpty()) {
            alert('Моля, положете подпис.');
            return;
        }
        const signatureDataURL = signaturePad.toDataURL('image/png');
        
        socket.emit('submit_signature', { 
            signature: signatureDataURL,
            browser_sid: currentBrowserSid 
        });
        
        signaturePad.clear();
        signatureScreen.style.display = 'none';
        waitingScreen.style.display = 'flex';
    });
});
</script>
</body>
</html>