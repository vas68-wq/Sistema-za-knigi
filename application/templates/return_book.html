{% extends "base.html" %}

{% block title %}Връщане на книга{% endblock %}

{% block content %}
<a href="{{ url_for('main.index') }}" class="text-decoration-none text-dark">
    <h1><i class="bi bi-arrow-left-square"></i> Връщане на книга</h1>
</a>

<div class="mb-4">
    <div class="input-group">
        <input type="text" id="search-input" class="form-control" placeholder="Търси по инвентарен номер или име на читател..." autofocus>
        <span class="input-group-text"><i class="bi bi-search"></i></span>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>Заглавие</th>
                        <th>Читател</th>
                        <th>Краен срок</th>
                        <th>Статус</th>
                        <th class="text-center">Подпис</th>
                        <th class="text-center">Действия</th>
                    </tr>
                </thead>
                <tbody id="borrowed-books-tbody">
                    <tr>
                        <td colspan="6" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('search-input');
    const tableBody = document.getElementById('borrowed-books-tbody');
    const apiEndpoint = "{{ url_for('transactions.api_borrowed_books') }}";

    // Функция за зареждане и рендиране на книгите
    function fetchAndRenderBooks(query = '') {
        tableBody.innerHTML = `<tr><td colspan="6" class="text-center"><div class="spinner-border text-primary" role="status"></div></td></tr>`;

        fetch(`${apiEndpoint}?query=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                tableBody.innerHTML = ''; // Изчистваме предишното съдържание

                if (data.length === 0) {
                    const message = query ? `Няма намерени резултати за "${query}".` : 'Няма заети книги в момента.';
                    tableBody.innerHTML = `<tr><td colspan="6" class="text-center">${message}</td></tr>`;
                    return;
                }

                data.forEach(item => {
                    const statusBadge = item.fine > 0 
                        ? `<span class="badge bg-danger">Просрочена</span>`
                        : `<span class="badge bg-success">В срок</span>`;

                    const signatureButton = item.signature_path
                        ? `<a href="/signatures/${item.signature_path}" target="_blank" class="btn btn-sm btn-success"><i class="bi bi-pen-fill"></i> Подпис</a>`
                        : '---';

                    const rowHTML = `
                        <tr>
                            <td><a href="/book/${item.tom_no}">${item.title}</a><br><small class="text-muted">${item.author}</small></td>
                            <td><a href="/reader/${item.reader_no}">${item.full_name}</a></td>
                            <td>${item.due_date_formatted}</td>
                            <td>${statusBadge}</td>
                            <td class="text-center">${signatureButton}</td>
                            <td class="text-center">
                                <form action="/return_book/${item.borrow_id}" method="post" class="d-inline" onsubmit="return confirm('Сигурни ли сте, че искате да върнете тази книга?');">
                                    <button type="submit" class="btn btn-sm btn-success">
                                        <i class="bi bi-arrow-left-square"></i> Върни
                                    </button>
                                </form>
                            </td>
                        </tr>
                    `;
                    tableBody.insertAdjacentHTML('beforeend', rowHTML);
                });
            })
            .catch(error => {
                console.error('Грешка при зареждане на данните:', error);
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Възникна грешка.</td></tr>`;
            });
    }

    // Event listener за търсачката (работи, докато пишете)
    let debounceTimeout;
    searchInput.addEventListener('input', () => {
        clearTimeout(debounceTimeout);
        debounceTimeout = setTimeout(() => {
            fetchAndRenderBooks(searchInput.value);
        }, 300); // Изчаква 300ms след последното натискане на клавиш
    });

    // Първоначално зареждане на всички заети книги
    fetchAndRenderBooks();
});
</script>
{% endblock %}